import sys
sys.path.append('/opt/lampp/htdocs/Scan/')    #添加搜索路径

import random
import nmap
import socket
from etc.url获取概况信息 import url_ip
from scapy.layers.inet import IP,TCP
from scapy.sendrecv import sr1


# def ip_port(ip):
#     a = []
#     try:
#         nm = nmap.PortScannerYield()
#         res = nm.scan(hosts=ip, arguments='-sS')
#         for re in res:
#             port = list(re[1]['scan'][ip]['tcp'].keys())   #转换list方便再次加工
#         return port
#     except:
#         return a
            


# def ip_port(ip):
#     a = [7, 21, 22, 23, 25, 43, 53, 67, 68, 69, 79, 80, 81, 88, 109, 110, 113, 119, 123, 135, 135, 137, 138, 139,
# 143, 161, 162, 179, 194, 220, 389, 443, 445, 465, 513, 520, 546, 547, 554, 563, 631, 636, 991, 993,
# 995, 1080, 1194, 1433, 1434, 1494, 1521, 1701, 1723, 1755, 1812, 1813, 1863, 3269, 3306, 3307, 3389, 3544,
# 4369, 5060, 5061, 5355, 5432, 5671, 5672, 6379, 7001, 8080, 8081, 8082, 8088, 8443, 8883, 8888, 9443, 9988,15672, 27017, 50389, 50636, 61613, 61614]
#     port = []
#     for i in a:
#         try:
#             sport=random.randint(2000,3000)
#             seq=random.randint(9000,10000)
#             dport=i
#             pkg=IP(dst=ip)/TCP(sport=sport,dport=dport,flags='S',seq=seq)
#             res=sr1(pkg,timeout=1,verbose=False)
#             flag=res['TCP'].flags
#             if flag=='SA':
#                 port.append(dport)
#         except:
#             pass
#     return port



# def ip_port(ip):
#     a = [7, 21, 22, 23, 25, 43, 53, 67, 68, 69, 79, 80, 81, 88, 109, 110, 113, 119, 123, 135, 135, 137, 138, 139,
# 143, 161, 162, 179, 194, 220, 389, 443, 445, 465, 513, 520, 546, 547, 554, 563, 631, 636, 991, 993,
# 995, 1080, 1194, 1433, 1434, 1494, 1521, 1701, 1723, 1755, 1812, 1813, 1863, 3269, 3306, 3307, 3389, 3544,
# 4369, 5060, 5061, 5355, 5432, 5671, 5672, 6379, 7001, 8080, 8081, 8082, 8088, 8443, 8883, 8888, 9443, 9988,15672, 27017, 50389, 50636, 61613, 61614]
#     port = []
#     for i in a:
#         try:
#             sock = socket.socket()
#             sock.connect((ip, i))
#         except:
#             pass
#         else:
#             port.append(i)
#     return port

def ip_port(ip):
    a = [7, 21, 22, 23, 25, 43, 53, 67, 68, 69, 79, 80, 81, 88, 109, 110, 113, 119, 123, 135, 135, 137, 138, 139,
143, 161, 162, 179, 194, 220, 389, 443, 445, 465, 513, 520, 546, 547, 554, 563, 631, 636, 991, 993,
995, 1080, 1194, 1433, 1434, 1494, 1521, 1701, 1723, 1755, 1812, 1813, 1863, 3269, 3306, 3307, 3389, 3544,
4369, 5060, 5061, 5355, 5432, 5671, 5672, 6379, 7001, 8080, 8081, 8082, 8088, 8443, 8883, 8888, 9443, 9988,15672, 27017, 50389, 50636, 61613, 61614]
    port = []
    for i in a:
        try:
            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)   #设置地址族和连接的方式
            s.settimeout(0.1)
            result = s.connect_ex((ip, i))   
            if result == 0:
                # print(f"Port {port} is open")
                port.append(i)
            s.close()
        except:
            pass
    return port


def ip_port_write():
    with open('../opt/前端传url.txt','r') as file:
        url = file.readline()
        ip = url_ip(url)
        # print(ip)
        port = ip_port(ip)
    with open('../opt/IP开放端口.txt','w') as fi:
        for por in port:
            fi.write(f'{por}\n')
    return True

# ip_port_write()