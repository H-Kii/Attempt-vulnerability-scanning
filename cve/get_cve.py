import json
import urllib.request

'''
获取url -> 从配置文件获取poc -> 判断request方式 -> 判断payload数量 -> 发送请求 -> 查看响应码
'''

class get_cve:
    def __init__(self):   #读取指定文件
        with open('../opt/前端传url.txt','r') as file:
            self.url = file.readline()
        with open('../cve/cvepayload.json','r') as file:
            self.payload = json.load(file)
        self.heards = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0) Gecko/20100101 Firefox/46.0","Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"}
    def jude_payload(self):
        for pay in self.payload.values():
            if pay['request'] == 'get':
                try:
                    poc = self.url+pay['payload']
                    # print(poc)
                    hear = urllib.request.Request(url=poc,headers=self.heards)   #设置请求头
                    response = urllib.request.urlopen(hear)   #不使用requests防止url编码被改变
                    code = response.status
                    res = response.read().decode('utf-8')
                    # print(res)
                    # print(code)               
                    if str(code) == pay['reply']:
                        a = f"存在{pay['number']}漏洞"
                        print(a)
                        return a
                    elif pay['reply'] in res:
                        a = f"存在{pay['number']}漏洞"
                        print(a)
                        return a
                except:
                    pass

get_cve = get_cve()
def get():
    a = get_cve.jude_payload()
    return a

